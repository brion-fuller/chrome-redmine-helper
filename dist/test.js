function Projects(){this.loaded=!1;this.projects=[]}Projects.prototype.all=function(a){if(this.loaded&&!a)return this.projects;this.loadFromMemory();(1>this.projects.length||a)&&this.loadFromRedmine();return this.projects};
Projects.prototype.get=function(a,b){var c=this.getById(a);if(!c.project)return!1;if(c.project.fullyLoaded&&!b)return this.getMembers(a),c.project;var d=this;getLoader().get("projects/"+a+".json?include=trackers,issue_categories",function(b){b.project.fullyLoaded=!0;var e=c.key||!1;!1!==e&&(d.projects[e]=merge(d.projects[e],b.project),d.store(),d.sendProjectUpdated(a,d.projects[e]))});return c.project};
Projects.prototype.getMembers=function(a,b){var c=this.getById(a);if(!c||!c.project)return[];if(!b&&c.project.membersLoaded)return c.project.members;var d=this;getLoader().get("projects/"+a+"/memberships.json",function(b){if(b.total_count&&0<b.total_count&&b.memberships){d.projects[c.key].members=[];for(var e in b.memberships)d.projects[c.key].members.push(b.memberships[e].user);d.projects[c.key].membersLoaded=!0;d.store();d.sendProjectUpdated(a,d.projects[c.key])}},function(b,e){e.status&&403==e.status&&
(d.projects[c.key].membersLoaded=!0,d.projects[c.key].members=getUsers().users,d.store(),d.sendProjectUpdated(a,d.projects[c.key]))})};Projects.prototype.getByIdentifier=function(a){for(var b in this.projects)if(this.projects[b].identifier==a)return{key:b,project:this.projects[b]};return!1};Projects.prototype.getById=function(a){var b={key:!1,project:!1},c;for(c in this.projects)this.projects[c].id==a&&(b={key:c,project:this.projects[c]});return b};
Projects.prototype.getProjectKey=function(a){for(var b in this.projects)if(this.projects[b].identifier==a)return b;return!1};Projects.prototype.loadFromRedmine=function(){this.projects=[];var a=this;getLoader().get("projects.json",function(b){b.total_count&&0<b.total_count&&(a.projects=b.projects,a.loaded=!0,a.store(),chrome.extension.sendMessage({action:"projectsLoaded",projects:a.projects}))})};Projects.prototype.store=function(){this.loaded&&(localStorage.projects=JSON.stringify(this.projects))};
Projects.prototype.loadFromMemory=function(){this.loaded||(this.projects=JSON.parse(localStorage.projects||"[]"),this.loaded=!0)};Projects.prototype.clear=function(){localStorage.removeItem("projects");this.projects=[];this.loaded=!1};Projects.prototype.sendProjectUpdated=function(a,b){chrome.extension.sendMessage({action:"projectUpdated",project:b})};
Projects.prototype.getIssues=function(a,b,c){var d=this.getById(a);if(!d.key||!d.project)return[];var f=parseInt(d.key);if(this.projects[f].issuesLoaded&&!c)return this.projects[f].issues;if(c||!this.projects[f].issues)this.projects[f].issues=[];b=b||0;var e=this;getLoader().get("issues.json?sort=updated_on:desc&project_id="+a+"&limit=50&offset="+b,function(c){if(!c.issues||!c.total_count||1>c.total_count)return[];for(var d in c.issues)e.projects[f].issues.push(c.issues[d]);e.projects[f].issuesLoaded=
!0;e.sendProjectUpdated(a,e.projects[f]);e.store();c.total_count>b+50&&e.getIssues(e.projects[f].id,b+50,!1)});return[]};
function Issues(){this.lastUpdated=!1;localStorage.lastUpdated&&(this.lastUpdated=new Date(localStorage.lastUpdated));this.issues=JSON.parse(localStorage.issues||"[]");this.unread=0;this.statuses=JSON.parse(localStorage.issueStatuses||"[]");this.statusesLoaded=localStorage.statusesLoaded||!1;this.priorities=JSON.parse(localStorage.priorities||"[]");this.prioripiesLoaded=localStorage.prioripiesLoaded||!1;this.updateUnread(!0)}
Issues.prototype.updateUnread=function(a){this.unread=0;for(var b in this.issues)this.issues[b].read||(this.unread+=1);a&&setUnreadIssuesCount(this.unread)};Issues.prototype.getUnreadCount=function(){return this.unread};
Issues.prototype.load=function(a,b,c){a=a||0;a=parseInt(a);b=b||25;"undefined"==typeof c&&(c=!1);var d=this,f="",f=c?"issues.json?sort=updated_on:desc&watcher_id="+getConfig().getProfile().currentUserId+"&limit="+b+"&offset="+a:"issues.json?sort=updated_on:desc&assigned_to_id="+getConfig().getProfile().currentUserId+"&limit="+b+"&offset="+a;getLoader().get(f,function(e){var f=0,j=[];if(e.total_count&&0<e.total_count){for(var g in e.issues){var k=!1;if(!("selected"==getConfig().getProjectsSettings().show_for&&
-1==getConfig().getProjectsSettings().list.indexOf(e.issues[g].project.id))){for(var h in d.issues)d.issues[h].id==e.issues[g].id&&(k=!0,new Date(d.issues[h].updated_on)<new Date(e.issues[g].updated_on)&&(e.issues[g].read=!1,c&&(e.issues[g].watcher=d.issues[h].assigned_to.id==getConfig().getProfile().currentUserId?!1:!0),d.issues[h]=e.issues[g],f+=1,getUsers().grabFromIssue(e.issues[g]),"updated"==getConfig().getNotifications().show&&j.push(d.issues[h])));k||(getUsers().grabFromIssue(e.issues[g]),
e.issues[g].read=!1,c&&(e.issues[g].watcher=d.issues[h].assigned_to.id==getConfig().getProfile().currentUserId?!1:!0),d.issues.push(e.issues[g]),f+=1,"new"==getConfig().getNotifications().show&&j.push(d.issues[h]))}}d.lastUpdated=new Date;d.updateUnread(!0);d.store();d.getStatuses();chrome.extension.sendMessage({action:"issuesUpdated"});!c&&e.total_count>a+b&&f>=b?d.load(a+b,b):c||d.load(0,b,!0);c&&e.total_count>a+b&&f>=b&&d.load(a+b,b,!0);0<j.length&&d.showNotifications(j)}})};
Issues.prototype.showNotifications=function(a){var b="",c="";1==a.length?(c="You have an update in Redmine",b="Issue: "+a[0].subject+" updated !"):1<a.length&&(c="You have updates in Redmine",b="You have "+a.length+" updated issue into Redmine");notification=webkitNotifications.createNotification("icon/icon-48.png",c,b);notification.show();chrome.alarms.create("notifications",{delayInMinutes:0.2})};
Issues.prototype.get=function(a,b){if(!a.detailsLoaded||b){var c=this;getLoader().get("issues/"+a.id+".json?include=journals,changesets,attachments",function(b){if(b.issue){var f=c.getById(b.issue.id);f.issue&&(getUsers().grabFromIssue(b.issue),b.issue.detailsLoaded=!0,c.issues[f.key]=merge(c.issues[f.key],b.issue),c.store(),chrome.extension.sendMessage({action:"issueDetails",id:a.id,issue:c.issues[f.key]}))}})}};
Issues.prototype.comment=function(a,b){if(this.getById(a).issue)return this.update(a,{notes:b})};Issues.prototype.update=function(a,b){if(!(null===b||"object"!=typeof b)){var c=this.getById(a);if(c.issue){var d=this,f={issue:b};getLoader().put("issues/"+a+".json",JSON.stringify(f),function(){d.get(c.issue,!0)},function(a,b){if(b&&4==b.readyState&&422==b.status){var c=JSON.parse(b.response);chrome.extension.sendMessage({action:"customError",type:"issueUpdate",errors:c})}})}}};
Issues.prototype.create=function(a){var b={issue:a};getLoader().post("issues.json",JSON.stringify(b),function(b){chrome.extension.sendMessage({action:"issueCreated",issue:b.issue||a})},function(b,a){if(a&&4==a.readyState&&422==a.status){var f=JSON.parse(a.response);chrome.extension.sendMessage({action:"customError",type:"issueCreate",errors:f})}})};Issues.prototype.markAsUnRead=function(a){a=this.getById(a);a.issue&&(this.issues[a.key].read=!1,this.unread+=1,setUnreadIssuesCount(this.unread),this.store())};
Issues.prototype.markAsRead=function(a){a=this.getById(a);a.issue&&(this.issues[a.key].read=!0,this.unread-=1,setUnreadIssuesCount(this.unread),this.store())};Issues.prototype.markAllAsRead=function(){for(var a in this.issues)this.issues[a].read=!0;this.store();this.updateUnread(!0)};Issues.prototype.getById=function(a){var b={key:!1,issue:!1};if(1>this.issues.length)return!1;for(var c in this.issues)this.issues[c].id==a&&(b={key:c,issue:this.issues[c]});return b};
Issues.prototype.getStatuses=function(a){if(this.statusesLoaded&&!a)return this.statuses;var b=this;getLoader().get("issue_statuses.json",function(a){a.issue_statuses&&0<a.issue_statuses.length&&(b.statuses=a.issue_statuses,b.statusesLoaded=!0,b.store(),chrome.extension.sendMessage({action:"issueStatusesUpdated",statuses:b.statuses}))});return this.statuses};Issues.prototype.getPriorities=function(){};
Issues.prototype.getStatusNameById=function(a){if(!this.statusesLoaded)return this.getStatuses(),a;for(var b in this.statuses)if(this.statuses[b].id==a)return this.statuses[b].name;return a};Issues.prototype.clearIssues=function(){this.issues=[];this.store();this.load()};
Issues.prototype.store=function(){localStorage.issues=JSON.stringify(this.issues);this.lastUpdated||(this.lastUpdated=new Date);localStorage.lastUpdated=this.lastUpdated.toISOString();localStorage.issueStatuses=JSON.stringify(this.statuses);localStorage.statusesLoaded=this.statusesLoaded};function Users(){this.loaded=localStorage.users_loaded||!1;this.users=JSON.parse(localStorage.users||"[]")}Users.prototype.grabFromIssue=function(a){this.push(a.assigned_to);this.push(a.author)};
Users.prototype.push=function(a){if(a&&a.id&&a.name){for(var b in this.users)if(this.users[b].id==a.id)return;this.users.push(a);this.store()}};Users.prototype.load=function(a){(a||!this.loaded)&&getLoader().get("users.json",function(a){console.log(a)},function(){})};Users.prototype.getNameById=function(a){for(var b in this.users)if(this.users[b].id==a)return this.users[b].name;return a};Users.prototype.store=function(){localStorage.users=JSON.stringify(this.users);localStorage.users_loaded=this.loaded};
function News(){}News.prototype.load=function(a,b){a||(a=function(){});b||(b=function(){});getLoader().get("news.json",a,b)};
